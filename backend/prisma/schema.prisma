// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  firstName     String?
  lastName      String?
  phone         String?
  avatar        String?
  role          UserRole  @default(CUSTOMER)
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  addresses     Address[]
  orders        Order[]
  reviews       Review[]
  cart          Cart?
  cartItems     CartItem[]
  wishlist      WishlistItem[]
  couponsUsed   CouponUsage[]
  refreshTokens RefreshToken[]
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

// Refresh Token Model for JWT token management
model RefreshToken {
  id          String   @id @default(cuid())
  token       String   @unique
  userId      String
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
}

// Address Model
model Address {
  id            String   @id @default(cuid())
  userId        String
  fullName      String
  phone         String
  addressLine1  String
  addressLine2  String?
  city          String
  state         String
  postalCode    String
  country       String
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Category Model
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  image       String?
  parentId    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  products    Product[]
}

// Product Model
model Product {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  description   String
  price         Float
  salePrice     Float?
  comparePrice  Float?
  sku           String    @unique
  categoryId    String
  imageUrl      String?
  images        String[]
  sizes         String[]
  colors        String[]
  stockQuantity Int       @default(0)
  isActive      Boolean   @default(true)
  isFeatured    Boolean   @default(false)
  tags          String[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  category      Category       @relation(fields: [categoryId], references: [id])
  orderItems    OrderItem[]
  reviews       Review[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]
  inventoryLogs InventoryLog[]
}

// Cart Model
model Cart {
  id          String     @id @default(cuid())
  userId      String     @unique
  couponId    String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupon      Coupon?    @relation(fields: [couponId], references: [id])
  items       CartItem[]
}

// Cart Item Model
model CartItem {
  id          String   @id @default(cuid())
  cartId      String?
  userId      String
  productId   String
  quantity    Int      @default(1)
  size        String?
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  cart        Cart?    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId, size, color])
}

// Wishlist Model
model WishlistItem {
  id          String   @id @default(cuid())
  userId      String
  productId   String
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId])
}

// Order Model
model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique
  userId          String
  couponId        String?
  status          OrderStatus   @default(PENDING)
  subtotal        Float
  discount        Float         @default(0)
  shippingCost    Float
  tax             Float
  total           Float
  paymentMethod   PaymentMethod
  paymentStatus   PaymentStatus @default(PENDING)
  paymentIntentId String?
  shippingAddress Json
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  user            User          @relation(fields: [userId], references: [id])
  coupon          Coupon?       @relation(fields: [couponId], references: [id])
  items           OrderItem[]
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  BANK_TRANSFER
  MOBILE_MONEY
  CASH_ON_DELIVERY
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// Order Item Model
model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  productName String
  quantity    Int
  price       Float
  size        String?
  color       String?
  createdAt   DateTime @default(now())
  
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])
}

// Review Model
model Review {
  id          String   @id @default(cuid())
  userId      String
  productId   String
  rating      Int
  title       String?
  comment     String
  images      String[]
  isVerified  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId])
}

// Coupon Model
model Coupon {
  id                 String          @id @default(cuid())
  code               String          @unique
  description        String?
  discountType       DiscountType
  discountValue      Float
  minPurchaseAmount  Float?
  maxDiscountAmount  Float?
  usageLimit         Int?
  perUserLimit       Int?
  usedCount          Int             @default(0)
  validFrom          DateTime?
  validUntil         DateTime?
  isActive           Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  
  carts              Cart[]
  orders             Order[]
  usages             CouponUsage[]
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

// Coupon Usage Tracking
model CouponUsage {
  id          String   @id @default(cuid())
  couponId    String
  userId      String
  orderId     String?
  usedAt      DateTime @default(now())
  
  coupon      Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([couponId, userId])
}

// Inventory Log Model
model InventoryLog {
  id          String            @id @default(cuid())
  productId   String
  type        InventoryLogType
  quantity    Int
  reason      String?
  createdBy   String?
  createdAt   DateTime          @default(now())
  
  product     Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId, createdAt])
}

enum InventoryLogType {
  RESTOCK
  SALE
  RETURN
  DAMAGED
  ADJUSTMENT
}
